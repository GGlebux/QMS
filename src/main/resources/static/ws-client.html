<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>WebSocket Ticket Viewer</title>

    <!-- STOMP + SockJS -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <style>
        body { font-family: sans-serif; padding: 20px; }
        #log { white-space: pre-wrap; background: #f6f6f6; padding: 15px; border-radius: 10px; }
    </style>
</head>
<body>

<h2>üîå WebSocket Test Client</h2>

<p><b>JWT —Ç–æ–∫–µ–Ω:</b></p>
<textarea id="jwtInput" style="width: 100%; height: 80px;"></textarea>

<br><br>
<button onclick="connect()">‚ñ∂ –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
<button onclick="disconnect()">‚èπ –û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>

<h3>–õ–æ–≥–∏:</h3>
<div id="log"></div>

<script>

    // üìå –¢–í–û–ô URL –≤–µ–±—Å–æ–∫–µ—Ç–∞
    const WS_URL = "http://localhost:8080/ws";

    // global stomp client
    let stompClient = null;

    // –¥–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –ª–æ–≥
    function log(message) {
        document.getElementById("log").textContent += message + "\n";
    }

    // –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
    function connect() {
        const jwt = document.getElementById("jwtInput").value.trim();

        if (!jwt) {
            alert("–í—Å—Ç–∞–≤—å JWT —Ç–æ–∫–µ–Ω!");
            return;
        }

        const socket = new SockJS(
            `${WS_URL}?token=${jwt}`,
            null,
            { transports: ["websocket"] } // –í–ê–ñ–ù–û ‚Äî –∑–∞–ø—Ä–µ—â–∞–µ–º jsonp/xhr
        );

        stompClient = Stomp.over(socket);

        log("–ü–æ–¥–∫–ª—é—á–∞—é—Å—å...");

        // –ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ STOMP
        stompClient.connect({}, (frame) => {
            log("‚úî –ü–æ–¥–∫–ª—é—á–µ–Ω–æ: " + frame);

            // üìå –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            //     Spring –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ convertAndSendToUser(username, "/queue/tickets")
            stompClient.subscribe("/user/queue/tickets", (msg) => {
                const body = JSON.parse(msg.body);
                log("üì© –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:");
                log(JSON.stringify(body, null, 2));
            });

            log("–û–∂–∏–¥–∞—é –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∏–ª–µ—Ç–æ–≤...");
        }, (err) => {
            log("‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: " + err);
        });
    }

    // –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ
    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect(() => {
                log("‚õî –û—Ç–∫–ª—é—á–µ–Ω–æ");
            });
        }
    }

</script>

</body>
</html>
